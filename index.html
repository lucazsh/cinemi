<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        html {
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        body {
            background-color: #f9faff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        span {
            color:#18191e;
        }
        .navh {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 50%;
            transform: translateX(-50%);
            border-radius: 20px;
            display: flex;
            gap: calc((100% - 50px) / 4);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .navh.hide {
            opacity: 0;
            pointer-events: none;
        }
        button,
        a {
            outline: none;
            border: none;
            background-color: #f9faff;
            -webkit-tap-highlight-color: transparent;
        }
        .navh button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            border: none;
            background: none;
            padding: 6px 10px;
            border-radius: 20%;
            cursor: pointer;
            transition: background 0.4s;
        }
        .navh button.active {
            background: rgba(225, 225, 231, 0.507);
        }
        .navh button span {
            opacity: 1;
            font-size: 12px;
        }
        .navh button svg {
            width: 24px;
            height: 24px;
        }
        .view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(100% - 85px);
            margin-bottom: 85px;
            padding: 0 20px;
            opacity: 0;
            pointer-events: none;
            transition: 0.19s ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }
        .view.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }
        .nt {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 3.4%;
            background-color: #f9faff;
            position: sticky;
            overflow: visible;
            top: 0;
        }
        .logo {
            font-size: 26px;
            font-weight: bold;
        }
        .post {
            margin-top: 5px;
            padding: 0px 3%;
        }
        .usr {
            font-weight: bold;
        }
        .time {
            color: rgb(56, 56, 56);
        }
        .pt {
            padding: 10px 0;
        }
        .cnt {
            padding-top: 2px;
        }
        .re {
            padding-top: 2px;
            margin-left: -6.5px;
        }
        #setup {
            height: 100vh;
            display: flex;
            z-index: 1200;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
            background: #f9faff;
        }
        .progress-bar {
            width: 100%;
            height: 16px;
            background: rgba(207, 205, 205, 0.582);
            border-radius: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: black;
            font-size: 12px;
            text-align: center;
            line-height: 18px;
            transition: width 0.4s ease;
        }
        .questions {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .question {
            display: none;
        }
        .question.active {
            display: block;
        }
        .next {
            align-self: flex-end;
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background: black;
            color: white;
            cursor: pointer;
        }
        .q-input {
            margin-top: 20px;
            width: 90%;
            max-width: 420px;
            padding: 14px;
            font-size: 16px;
            border-radius: 14px;
            border: 1px solid #ccc;
            outline: none;
        }
        .q-input:focus {
            border-color: black;
        }
        .q-yn {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            -webkit-tap-highlight-color: transparent;
        }
        .q-yn input {
            display: none;
        }
        .q-yn label {
            padding: 12px 32px;
            border-radius: 14px;
            border: 1px solid black;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
            user-select: none;
        }
        .q-yn input:checked + label {
            background: black;
            color: white;
        }
        #add {
            position: fixed;
            left: 0;
            right: 0;
            top: 1.4vh;
            bottom: calc(var(--navh-gap) + env(safe-area-inset-bottom) + var(--navh-height));
            transform: translateY(100%);
            background-color: #f9faff;
            z-index: 1200;
            height: 100%;
            border-top: 1px solid #18191e52;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
            box-sizing: border-box;
        }
        #add.active {
            transform: translateY(0);
            pointer-events: auto;
            opacity: 1;
        }
        .tp-add {
            position: relative;
            font-size: 18px;
            display: flex;
            padding: 15px 10px;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        .add-t {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
        }
        .ti-add {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .ti-add .username {
            padding: 12px;
            font-size: 16px;
            border-radius: 12px;
            border: 1px solid #ccc;
            outline: none;
            display: inline-block;
        }
        .ti-add textarea {
            padding: 12px;
            font-size: 16px;
            border-radius: 12px;
            border: 1px solid #ccc;
            outline: none;
            resize: none;
            width: 100%;
            box-sizing: border-box;
        }
        .ti-add .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }
        .ti-add .left-controls {
            display: flex;
            gap: 12px;
        }
        .btn-p {
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            background: black;
            color: white;
            cursor: pointer;
        }
        .btn-g {
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #ccc;
            background: #f9faff;
            cursor: pointer;
        }
        .fp {
            margin-top: 6px;
            display:flex;
            gap:8px;
            flex-wrap:wrap;
        }
        .fc {
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px;
            border-radius:10px;
            border:1px solid #e1e1e6;
            background:#fff;
            font-size:13px;
            max-width:160px;
            box-sizing:border-box;
            position:relative;
        }
        .ft {
            width:56px;
            height:56px;
            border-radius:8px;
            object-fit:cover;
            background:#f2f2f6;
            flex-shrink:0;
        }
        .fn {
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
        }
        .fr {
            position:absolute;
            top:-6px;
            right:-6px;
            background:#111;
            color:white;
            border-radius:10px;
            width:20px;
            height:20px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            font-size:12px;
            border:2px solid white;
        }
    </style>
</head>
<body>
    <div id="setup" class="view">
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        <div class="questions">
            <div class="question active">
                <h1>What motivates you the most?</h1>
                <input class="q-input" type="text" placeholder="Type your answer..." />
            </div>
            <div class="question">
                <h1>Do you prefer working alone or in a team?</h1>
                <div class="q-yn">
                    <input type="radio" id="q2a" name="q2">
                    <label for="q2a">Yes</label>
                    <input type="radio" id="q2b" name="q2">
                    <label for="q2b">No</label>
                </div>
            </div>
            <div class="question">
                <h1>Are you more logical or creative?</h1>
                <input class="q-input" type="text" placeholder="Logical / Creative / Both..." />
            </div>
            <div class="question">
                <h1>Do you like taking risks?</h1>
                <div class="q-yn">
                    <input type="radio" id="q4a" name="q4">
                    <label for="q4a">Yes</label>
                    <input type="radio" id="q4b" name="q4">
                    <label for="q4b">No</label>
                </div>
            </div>
            <div class="question">
                <h1>Do you plan ahead or improvise?</h1>
                <div class="q-yn">
                    <input type="radio" id="q5a" name="q5">
                    <label for="q5a">Yes</label>
                    <input type="radio" id="q5b" name="q5">
                    <label for="q5b">No</label>
                </div>
            </div>
            <div class="question">
                <h1>What defines success for you?</h1>
                <input class="q-input" type="text" placeholder="Your definition..." />
            </div>
        </div>
        <button class="next" onclick="nextQuestion()">Next</button>
    </div>
    <div id="home" class="view active">
        <div class="nt">
            <span class="logo">
                cinemi
            </span>
            <span class="search">
                <button><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M380-320q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></button>
            </span>
        </div>
        <div id="posts">
            <div class="post">
                <div class="pt">
                    <span class="usr">user_tag</span>
                    <span class="time">2h</span>
                    <div class="cnt">
                        I like this movie: [SAMPLE], because... and...
                    </div>
                    <div class="re">
                        <button class="like"><svg xmlns="http://www.w3.org/2000/svg" height="21px" viewBox="0 -960 960 960" width="21px" fill="#666666"><path d="M480-170q-13 0-25.5-4.5T431-189l-59-54q-109-97-192.5-189.5T96-634q0-88.02 59.85-147.01Q215.7-840 305-840q51.2 0 96.6 21.5Q447-797 480-757q35-40 79.66-61.5t95.02-21.5Q744-840 804-781.01T864-634q0 109-83.5 201.5T588-243l-59 54q-11 10-23.5 14.5T480-170Zm-34-512q-24-41-60-63.5T305-768q-58.71 0-97.86 38Q168-692 168-633.61 168-583 204-527t86 109.5Q340-364 393-318t87 76q34-30 87-76t103-99.5Q720-471 756-527t36-106.61Q792-692 752.86-730q-39.15-38-97.86-38-45 0-81.5 22.5T513-682q-5 10-14.05 14.5t-19 4.5q-9.95 0-19.45-4.5T446-682Zm34 177Z"/></svg></button>
                        <button class="reply"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666666"><path d="m282-474 98 98q11 11 11 25.5t-11 25.98Q369-314 354.5-314T329-325L169-485q-11-10.64-11-24.82T169-535l160-160q11-11 25.67-11 14.66 0 25.33 11 11 10.67 11 25.33Q391-655 380-644l-98 98h342q79.68 0 135.84 56.16T816-354v108q0 15.3-10.29 25.65Q795.42-210 780.21-210t-25.71-10.35Q744-230.7 744-246v-108q0-50-35-85t-85-35H282Z"/></svg></button>
                        <button class="send"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666666"><path d="M780-447 193-212q-18 7-33.5-3.5T144-245v-470q0-19 15.5-29.5T193-748l587 235q23 9 23 33t-23 33ZM216-299l454-181-454-181v109l216 72-216 72v109Zm0 0v-362 362Z"/></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="finder" class="view">
        <div class="nt">
            <span style="font-size: 21px; font-weight: bold;">
                Movi <span style="color: grey; font-size: 20px;">v1</span>
            </span>
            <span class="search">
                <button><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M380-320q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l224 224q11 11 11 28t-11 28q-11 11-28 11t-28-11L532-372q-30 24-69 38t-83 14Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></button>
            </span>
        </div>
        <div class="chat">
            <div class="us">
                hello
            </div>
            <div class="as">
                Hello! How can I assist you today?
            </div>
        </div>
        <div class="input"></div>
    </div>
    <div id="add" class="view">
        <div class="tp-add">
            <button onclick="closeAdd()" style="color: #18191ec2; font-size: 16px; align-items: center;  ">Cancel</button>
            <span class="add-t" style="color:black;font-weight: bold;">New post</span>
            <button><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560Zm120 480h200q17 0 28.5-11.5T560-320q0-17-11.5-28.5T520-360H320q-17 0-28.5 11.5T280-320q0 17 11.5 28.5T320-280Zm0-160h320q17 0 28.5-11.5T680-480q0-17-11.5-28.5T640-520H320q-17 0-28.5 11.5T280-480q0 17 11.5 28.5T320-440Zm0-160h320q17 0 28.5-11.5T680-640q0-17-11.5-28.5T640-680H320q-17 0-28.5 11.5T280-640q0 17 11.5 28.5T320-600Z"/></svg></button>
        </div>
        <div class="ti-add">
            <span id="addUsername" class="username">user_tag</span>
            <textarea id="postTextarea" placeholder="What's on your mind?" rows="4"></textarea>
            <input id="postFiles" type="file" accept="image/*,video/*,application/pdf" multiple style="display:none">
            <div id="filePreview" class="fp" aria-live="polite"></div>
            <div class="controls">
                <div class="left-controls">
                    <button class="btn-g" title="Add photo" onclick="document.getElementById('postFiles').click()"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0 0v-560 560Zm80-80h400q12 0 18-11t-2-21L586-459q-6-8-16-8t-16 8L450-320l-74-99q-6-8-16-8t-16 8l-80 107q-8 10-2 21t18 11Z"/></svg></button>
                    <button class="btn-g" title="Add audio" onclick="document.getElementById('postFiles').click()"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M720-330q0 104-73 177T470-80q-104 0-177-73t-73-177v-370q0-75 52.5-127.5T400-880q75 0 127.5 52.5T580-700v350q0 46-32 78t-78 32q-46 0-78-32t-32-78v-330q0-17 11.5-28.5T400-720q17 0 28.5 11.5T440-680v330q0 13 8.5 21.5T470-320q13 0 21.5-8.5T500-350v-350q-1-42-29.5-71T400-800q-42 0-71 29t-29 71v370q-1 71 49 120.5T470-160q70 0 119-49.5T640-330v-350q0-17 11.5-28.5T680-720q17 0 28.5 11.5T720-680v350Z"/></svg></button>
                </div>
                <div>
                    <button id="postSubmit" class="btn-p">Post</button>
                </div>
            </div>
        </div>
    </div>
    <div id="profile" class="view">
        <h2>
            This is the settings tab...
        </h2>
    </div>
    <div class="navh">
        <button class="active" onclick="showView('home')">
            <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px" fill="#000000"><path d="M160-186.67v-380q0-15.83 7.08-30 7.09-14.16 19.59-23.33L440-810q17.45-13.33 39.89-13.33T520-810l253.33 190q12.5 9.17 19.59 23.33 7.08 14.17 7.08 30v380q0 27.5-19.58 47.09Q760.83-120 733.33-120h-140q-14.16 0-23.75-9.58-9.58-9.59-9.58-23.75v-213.34q0-14.16-9.58-23.75-9.59-9.58-23.75-9.58h-93.34q-14.16 0-23.75 9.58-9.58 9.59-9.58 23.75v213.34q0 14.16-9.58 23.75-9.59 9.58-23.75 9.58h-140q-27.5 0-47.09-19.58Q160-159.17 160-186.67Z"/></svg>
            <span>Home</span>
        </button>
        <button onclick="showView('finder')">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M360-480q33 0 56.5-23.5T440-560q0-33-23.5-56.5T360-640q-33 0-56.5 23.5T280-560q0 33 23.5 56.5T360-480Zm240 0q33 0 56.5-23.5T680-560q0-33-23.5-56.5T600-640q-33 0-56.5 23.5T520-560q0 33 23.5 56.5T600-480ZM360-120v-160h80v160h-80Zm160 0v-160h80v160h-80Zm-320 0q-33 0-56.5-23.5T120-200v-400q0-100 70-170t170-70h240q100 0 170 70t70 170v400q0 33-23.5 56.5T760-120h-80v-160q0-33-23.5-56.5T600-360H360q-33 0-56.5 23.5T280-280v160h-80Z"/></svg>
            <span>Finder</span>
        </button>
        <button onclick="showView('add')">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M440-440v120q0 17 11.5 28.5T480-280q17 0 28.5-11.5T520-320v-120h120q17 0 28.5-11.5T680-480q0-17-11.5-28.5T640-520H520v-120q0-17-11.5-28.5T480-680q-17 0-28.5 11.5T440-640v120H320q-17 0-28.5 11.5T280-480q0 17 11.5 28.5T320-440h120ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/></svg>
            <span>Add</span>
        </button>
        <button>
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M234-276q51-39 114-61.5T480-360q69 0 132 22.5T726-276q35-41 54.5-93T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 59 19.5 111t54.5 93Zm246-164q-59 0-99.5-40.5T340-580q0-59 40.5-99.5T480-720q59 0 99.5 40.5T620-580q0 59-40.5 99.5T480-440Zm0 360q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Z"/></svg>
            <span>Profile</span>
        </button>
    </div>
<script>
let current = 0;
const questions = document.querySelectorAll('.question');
const progress = document.getElementById('progressFill');
const total = questions.length;
function nextQuestion() {
    questions[current].classList.remove('active');
    current++;
    if (current < total) {
        questions[current].classList.add('active');
        updateProgress();
    } else {
        progress.style.width = '100%';
        showView('home');
    }
}
function updateProgress() {
    const percent = Math.round((current / total) * 100);
    progress.style.width = percent + '%';
}
function showView(id) {
    const add = document.getElementById('add');
    if (id === 'add') {
        add.classList.add('active');
        setTimeout(() => {
            const ta = document.getElementById('postTextarea');
            if (ta) ta.focus();
        }, 120);
        updateNavActive(id);
        return;
    }
    add.classList.remove('active');
    document.querySelectorAll('.view').forEach(v => {
        if (v.id !== 'add') v.classList.remove('active');
    });
    document.getElementById(id).classList.add('active');
    updateNavActive(id);
}
function updateNavActive(id) {
    const buttons = document.querySelectorAll('.navh button');
    buttons.forEach(btn => btn.classList.remove('active'));
    const btn = Array.from(buttons).find(b => b.getAttribute('onclick')?.includes(id));
    if (btn) btn.classList.add('active');
}
function closeAdd() {
    const add = document.getElementById('add');
    add.classList.remove('active');
}
const postBtn = document.getElementById('postSubmit');
postBtn.setAttribute('type', 'button');
const postsContainer = document.getElementById('posts');
const textarea = document.getElementById('postTextarea');
const addUsername = document.getElementById('addUsername');
const fileInput = document.getElementById('postFiles');
const filePreview = document.getElementById('filePreview');
const addView = document.getElementById('add');
addView.addEventListener('submit', (e) => e.preventDefault());
let selectedFiles = [];
function escapeHtml(str) {
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
function timeLabelForNow() {
    return 'just now';
}
function uid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2,8);
}
fileInput && fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files || []);
    if (!files.length) return;
    const MAX_FILES = 6;
    const remaining = Math.max(0, MAX_FILES - selectedFiles.length);
    const toAdd = files.slice(0, remaining);
    toAdd.forEach(file => {
        const id = uid();
        const entry = { id, file, dataUrl: null };
        selectedFiles.push(entry);
        if (file.type.startsWith('image/')) {
            const fr = new FileReader();
            fr.onload = (ev) => {
                entry.dataUrl = ev.target.result;
                renderFilePreview(entry);
            };
            fr.readAsDataURL(file);
        } else {
            renderFilePreview(entry);
        }
    });
    fileInput.value = '';
});
function renderFilePreview(entry) {
    if (document.querySelector(`[data-file-id="${entry.id}"]`)) return;
    const el = document.createElement('div');
    el.className = 'fc';
    el.setAttribute('data-file-id', entry.id);
    if (entry.dataUrl) {
        const img = document.createElement('img');
        img.className = 'ft';
        img.src = entry.dataUrl;
        el.appendChild(img);
    } else {
        const ph = document.createElement('div');
        ph.className = 'ft';
        ph.style.display = 'flex';
        ph.style.alignItems = 'center';
        ph.style.justifyContent = 'center';
        ph.textContent = entry.file.type.split('/')[0] || 'file';
        el.appendChild(ph);
    }
    const name = document.createElement('div');
    name.className = 'fn';
    name.textContent = entry.file.name;
    el.appendChild(name);
    const remove = document.createElement('div');
    remove.className = 'fr';
    remove.title = 'Remove';
    remove.innerHTML = 'Ã—';
    remove.addEventListener('click', () => removeFile(entry.id));
    el.appendChild(remove);
    filePreview.appendChild(el);
}
function removeFile(id) {
    selectedFiles = selectedFiles.filter(f => f.id !== id);
    const node = document.querySelector(`[data-file-id="${id}"]`);
    if (node) node.remove();
}
function createPostWrapper(username, content, files, timeLabel) {
    const wrapper = document.createElement('div');
    wrapper.className = 'post';
    const safeContent = escapeHtml(content).replace(/\n/g, '<br>');
    let filesHtml = '';
    if (files && files.length) {
        const imgs = files.filter(f => (f.dataUrl || f.url) && (f.file ? f.file.type : f.mime).startsWith('image/'));
        const others = files.filter(f => !((f.dataUrl || f.url) && (f.file ? f.file.type : f.mime).startsWith('image/')));
        if (imgs.length) {
            filesHtml += '<div class="post-images" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">';
            imgs.forEach(f => {
                const src = f.dataUrl || f.url;
                filesHtml += `<img src="${src}" style="width:80%;border-radius:8px;object-fit:cover;max-width:500px;"/>`;
            });
            filesHtml += '</div>';
        }
        if (others.length) {
            filesHtml += '<div class="post-files" style="margin-top:8px">';
            others.forEach(f => {
                let url;
                if (f.url) {
                    url = f.url;
                } else if (f.file) {
                    url = URL.createObjectURL(f.file);
                    setTimeout(() => URL.revokeObjectURL(url), 60 * 1000);
                } else {
                    return;
                }
                const name = f.file ? f.file.name : f.originalName || '';
                filesHtml += `<div><a href="${url}" download="${escapeHtml(name)}">${escapeHtml(name)}</a></div>`;
            });
            filesHtml += '</div>';
        }
    }
    wrapper.innerHTML = `
        <div class="pt">
            <span class="usr">${escapeHtml(username)}</span>
            <span class="time">${timeLabel}</span>
            <div class="cnt">${safeContent}</div>
            ${filesHtml}
            <div class="re" style="margin-top:6px">
                <button class="like"><svg xmlns="http://www.w3.org/2000/svg" height="21px" viewBox="0 -960 960 960" width="21px" fill="#666666"><path d="M480-170q-13 0-25.5-4.5T431-189l-59-54q-109-97-192.5-189.5T96-634q0-88.02 59.85-147.01Q215.7-840 305-840q51.2 0 96.6 21.5Q447-797 480-757q35-40 79.66-61.5t95.02-21.5Q744-840 804-781.01T864-634q0 109-83.5 201.5T588-243l-59 54q-11 10-23.5 14.5T480-170Zm-34-512q-24-41-60-63.5T305-768q-58.71 0-97.86 38Q168-692 168-633.61 168-583 204-527t86 109.5Q340-364 393-318t87 76q34-30 87-76t103-99.5Q720-471 756-527t36-106.61Q792-692 752.86-730q-39.15-38-97.86-38-45 0-81.5 22.5T513-682q-5 10-14.05 14.5t-19 4.5q-9.95 0-19.45-4.5T446-682Zm34 177Z"/></svg></button>
                <button class="reply"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666666"><path d="m282-474 98 98q11 11 11 25.5t-11 25.98Q369-314 354.5-314T329-325L169-485q-11-10.64-11-24.82T169-535l160-160q11-11 25.67-11 14.66 0 25.33 11 11 10.67 11 25.33Q391-655 380-644l-98 98h342q79.68 0 135.84 56.16T816-354v108q0 15.3-10.29 25.65Q795.42-210 780.21-210t-25.71-10.35Q744-230.7 744-246v-108q0-50-35-85t-85-35H282Z"/></svg></button>
                <button class="send"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#666666"><path d="M780-447 193-212q-18 7-33.5-3.5T144-245v-470q0-19 15.5-29.5T193-748l587 235q23 9 23 33t-23 33ZM216-299l454-181-454-181v109l216 72-216 72v109Zm0 0v-362 362Z"/></svg></button>
            </div>
        </div>
    `;
    return wrapper;
}
function buildPostElement(username, content, files) {
    return createPostWrapper(username, content, files, timeLabelForNow());
}
function addPostToUIFromServer(post) {
    const timeLabel = post.createdAt ? new Date(post.createdAt).toLocaleString() : timeLabelForNow();
    if (post.tempId) {
        const existing = document.querySelector(`[data-temp-id="${post.tempId}"]`);
        if (existing) {
            const newWrapper = createPostWrapper(post.username, post.text, post.files, timeLabel);
            existing.parentNode.replaceChild(newWrapper, existing);
            lastTimestamp = Math.max(lastTimestamp, new Date(post.createdAt).getTime());
            return;
        }
    }
    const wrapper = createPostWrapper(post.username || 'user_tag', post.text || '', post.files || [], timeLabel);
    postsContainer.prepend(wrapper);
    lastTimestamp = Math.max(lastTimestamp, new Date(post.createdAt).getTime());
}
const SERVER_URL = 'https://f9ae704d4f43.ngrok-free.app'; 
const baseUrl = SERVER_URL ? SERVER_URL.replace(/\/$/, '') : '';
const ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
function replacePostButtonListener(newHandler) {
    const old = document.getElementById('postSubmit');
    if (!old) return;
    const clone = old.cloneNode(true);
    clone.setAttribute('type', 'button');
    old.parentNode.replaceChild(clone, old);
    window.postBtnNode = clone;
    clone.addEventListener('click', newHandler);
}
let lastTimestamp = 0;
async function loadInitialPostsFromServer() {
    if (!baseUrl) return;
    try {
        const res = await fetch(baseUrl + '/api/posts', {
            headers: ngrokHeaders
        });
        if (!res.ok) throw new Error('failed to load posts');
        const list = await res.json();
        list.slice().reverse().forEach(p => {
            addPostToUIFromServer(p);
        });
        if (list.length) {
            lastTimestamp = new Date(list[0].createdAt).getTime();
        }
    } catch (err) {}
}
async function pollForNewPosts() {
    try {
        const res = await fetch(`${baseUrl}/api/posts?since=${lastTimestamp}`, {
            headers: ngrokHeaders
        });
        if (!res.ok) return;
        const newPosts = await res.json();
        newPosts.forEach(addPostToUIFromServer);
    } catch (err) {}
}
async function submitPostToServerHandler(e) {
    e.preventDefault();
    e.stopPropagation();
    const content = document.getElementById('postTextarea')?.value || '';
    const username = document.getElementById('addUsername')?.textContent || 'user_tag';
    const selected = selectedFiles || [];
    if (content.trim() === '' && selected.length === 0) {
        const ta = document.getElementById('postTextarea');
        if (ta) {
            ta.focus();
            ta.style.borderColor = 'red';
            setTimeout(() => ta.style.borderColor = '#ccc', 900);
        }
        return;
    }
    const tempId = uid();
    const filesForPost = selected.map(f => ({ ...f }));
    const optimisticPostEl = buildPostElement(username, content, filesForPost);
    optimisticPostEl.setAttribute('data-temp-id', tempId);
    postsContainer.prepend(optimisticPostEl);
    const ta = document.getElementById('postTextarea');
    if (ta) ta.value = '';
    const fp = document.getElementById('filePreview');
    if (fp) fp.innerHTML = '';
    const fi = document.getElementById('postFiles');
    if (fi) fi.value = '';
    selectedFiles = [];
    try { document.getElementById('add').classList.remove('active'); } catch(e){}
    showView('home');
    const fd = new FormData();
    fd.append('username', username);
    fd.append('text', content);
    fd.append('tempId', tempId);
    selected.forEach((f) => fd.append('files', f.file, f.file.name));
    try {
        const btn = document.getElementById('postSubmit');
        if (btn) { btn.disabled = true; btn.textContent = 'Posting...'; }
        const res = await fetch(baseUrl + '/api/posts', {
            method: 'POST',
            body: fd,
            headers: ngrokHeaders
        });
        const json = await res.json();
        if (!res.ok) throw new Error(json?.error || 'upload failed');
    } catch (err) {
        console.error('Post error:', err);
        const optimisticEl = document.querySelector(`[data-temp-id="${tempId}"]`);
        if (optimisticEl) optimisticEl.remove();
        alert('Failed to post. Please try again.');
        if (ta) ta.value = content;
        selectedFiles = filesForPost;
        filesForPost.forEach(entry => renderFilePreview(entry));
        showView('add');
    } finally {
        const btn = document.getElementById('postSubmit');
        if (btn) { btn.disabled = false; btn.textContent = 'Post'; }
    }
}
function initSocket() {
    if (!baseUrl) return;
    try {
        const socket = io(baseUrl, { 
            transports: ['websocket','polling']
        });
        socket.on('connect', () => console.log('Socket connected'));
        socket.on('post_created', (post) => {
            addPostToUIFromServer(post);
        });
    } catch (err) {}
}
if (baseUrl) {
    replacePostButtonListener(submitPostToServerHandler);
    loadInitialPostsFromServer();
    initSocket();
    setInterval(pollForNewPosts, 5000);
    textarea && textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            submitPostToServerHandler(e);
        }
    });
} else {
    if (postBtn) postBtn.addEventListener('click', submitPost);
    textarea && textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            submitPost();
        }
    });
}
</script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>
</html>
